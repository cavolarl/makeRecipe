{% extends 'recipes/base.html' %}
{% load recipes_tags %}

{% block content %}
<div class="max-w-7xl mx-auto px-4">

    <!-- Help Section -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body">
            <h2 class="card-title">Help</h2>
            <p>
                The form accepts recipes from 
                <a href="https://www.ica.se/recept/" target="_blank" class="link link-primary">ICA</a>
                and 
                <a href="https://www.koket.se/recept/" target="_blank" class="link link-primary">Koket</a>.
            </p>
            <p>Paste the URL below and click the "Scrape" button.</p>
        </div>
    </div>

    <!-- Scraper Section -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body">
            <h2 class="card-title">Scrape Recipe from URL</h2>
            <div class="flex flex-col sm:flex-row gap-2">
                <input id="recipe-url" type="text" placeholder="Enter recipe URL..." class="input input-bordered w-full" />
                <button id="scrape-button" class="btn btn-primary">Scrape</button>
            </div>
            <div id="scraper-status" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <form method="post" novalidate>
        {% csrf_token %}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Left Column - Recipe Details -->
            <div class="space-y-4">
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body">
                        <h3 class="card-title text-xl mb-4">Recipe Details</h3>
                        
                        {% for field in form %}
                            <div class="form-control mb-4">
                                {{ field.label_tag }}
                                {{ field|add_class:"input input-bordered" }}
                                {% if field.help_text %}
                                    <span class="text-xs text-gray-500">{{ field.help_text }}</span>
                                {% endif %}
                                {% for error in field.errors %}
                                    <span class="text-red-500 text-sm">{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Right Column - Ingredients -->
            <div class="space-y-4">
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="card-title text-xl">Ingredients</h3>
                            <button type="button" id="add-ingredient" class="btn btn-secondary btn-sm">Add Ingredient</button>
                        </div>
                        
                        <div id="ingredient-formset-container" class="max-h-96 overflow-y-auto pr-2">
                            {{ formset.management_form }}
                            {% for form in formset %}
                                <div class="ingredient-form border border-base-300 rounded-lg mb-3 p-3 bg-base-50">
                                    {{ form.id }}
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="form-control">
                                            {{ form.name.label_tag }}
                                            {{ form.name }}
                                            <div class="flex items-center gap-2 mt-1">
                                                <input type="text" class="input input-bordered input-sm flex-grow autocomplete-ingredient" placeholder="Start typing..." value="{% if form.instance.name %}{{ form.instance.name.name }}{% endif %}">
                                                <button type="button" class="btn btn-outline btn-sm create-new-ingredient-btn">New</button>
                                            </div>
                                            {% for error in form.name.errors %}
                                                <span class="text-red-500 text-sm">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="form-control">
                                                {{ form.quantity.label_tag }}
                                                {{ form.quantity|add_class:"input input-bordered input-sm" }}
                                                {% for error in form.quantity.errors %}
                                                    <span class="text-red-500 text-sm">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                            <div class="form-control">
                                                {{ form.unit.label_tag }}
                                                {{ form.unit|add_class:"input input-bordered input-sm" }}
                                                {% for error in form.unit.errors %}
                                                    <span class="text-red-500 text-sm">{{ error }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center mt-2">
                                            {% if form.instance.pk %}
                                                <label class="label cursor-pointer">
                                                    {{ form.DELETE }}
                                                    <span class="label-text ml-2 text-sm">Delete</span>
                                                </label>
                                            {% else %}
                                                <div></div>
                                            {% endif %}
                                            <button type="button" class="btn btn-error btn-xs remove-ingredient">Remove</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty Form Template -->
        <div id="empty-form" class="hidden">
            <div class="ingredient-form border border-base-300 rounded-lg mb-3 p-3 bg-base-50">
                <div class="grid grid-cols-1 gap-2">
                    <div class="form-control">
                        {{ formset.empty_form.name.label_tag }}
                        {{ formset.empty_form.name }}
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" class="input input-bordered input-sm flex-grow autocomplete-ingredient" placeholder="Start typing..." />
                            <button type="button" class="btn btn-outline btn-sm create-new-ingredient-btn">New</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="form-control">
                            {{ formset.empty_form.quantity.label_tag }}
                            {{ formset.empty_form.quantity|add_class:"input input-bordered input-sm" }}
                        </div>
                        <div class="form-control">
                            {{ formset.empty_form.unit.label_tag }}
                            {{ formset.empty_form.unit|add_class:"input input-bordered input-sm" }}
                        </div>
                    </div>
                    <div class="flex justify-end mt-2">
                        <button type="button" class="btn btn-error btn-xs remove-ingredient">Remove</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="mt-6 flex justify-center">
            <button type="submit" class="btn btn-primary btn-lg">Add Recipe</button>
        </div>
    </form>
</div>

{% load static %}
<script src="{% static 'js/recipe_form.js' %}"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>
{% endblock %}
